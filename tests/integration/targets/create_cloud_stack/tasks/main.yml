---
- name: Create a Grafana Cloud stack
  grafana.grafana.cloud_stack:
    name: "{{ test_stack_name }}"
    stack_slug: "{{ test_stack_name }}"
    cloud_api_key: "{{ grafana_cloud_api_key }}"
    org_slug: "{{ org_name }}"
    state: present
  register: create_result

- name: Create Check
  ansible.builtin.assert:
    that:
      - create_result.url == "https://" + "{{ test_stack_name }}" + ".grafana.net"

- name: "{{ java_app_name }} - Check health through health endpoint"
  ansible.builtin.uri:
    url: "https://{{ test_stack_name }}.grafana.net"
    method: GET
    return_content: true
    status_code: 200
    timeout: 5
  register: _healthcheck_uri
  until: ((_healthcheck_uri.content | default('{}', true) | from_json).status | default('Unknown')) == 'UP'
  retries: 15
  delay: 15


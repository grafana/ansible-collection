- name: Create a Data Source
  grafana.grafana.datasource:
    datasource: {
      name: "ansible-integration",
      type: "influxdb",
      url: "https://grafana.github.com/grafana-ansible-collection",
      user: "user",
      secureJsonData:
        { password: "password" },
      database: "db-name",
      id: 123,
      uid: "ansibletest",
      access: "proxy"
    }
    stack_slug: "{{ stack_name }}"
    grafana_api_key: "{{ grafana_api_key }}"
    state: present
  register: create_result

- debug:
    var: create_result

- assert:
    that:
      - create_result.changed == true
      - create_result.output.message == "Datasource added"

- name: Update a Data Source
  grafana.grafana.datasource:
    datasource: {
      name: "ansible-integration",
      type: "influxdb",
      url: "https://grafana.github.com/grafana-ansible-collection",
      user: "user",
      secureJsonData:
        { password: "password" },
      database: "db-name-1",
      id: 123,
      uid: "ansibletest",
      access: "proxy"
    }
    stack_slug: "{{ stack_name }}"
    grafana_api_key: "{{ grafana_api_key }}"
    state: present
  register: update_result

- debug:
    var: update_result

- assert:
    that:
      - update_result.changed == true
      - update_result.output.message == "Datasource updated"